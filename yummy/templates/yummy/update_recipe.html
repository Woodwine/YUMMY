{% extends 'base.html' %}
{% load static %}
{% block add_css %}
<link rel="stylesheet" href="{% static 'yummy/css/style.css' %}">
{% endblock %}

{% block title %}Изменить рецепт{% endblock %}

{% block content %}
<div class="form-container container">

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-dismissible alert-danger">
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>{{ message }}</strong>
    </div>
    {% endfor %}
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {{ recipe_form.management_form }}
        {{ recipe_form.non_form_erros }}

        {% for field in recipe_form %}
        {% if field.image %}
        <div class="form-group image__form-control">
            <label class="col-form-label mt-1">{{ field.label_tag }}</label>
            {{ field.errors }}
            {{ field }}
        </div>
        {% else %}
        <div class="form-group">
            <label class="col-form-label mt-1">{{ field.label_tag }}</label>
            {{ field.errors }}
            {{ field }}
        </div>
        {% endif %}
        {% endfor %}

        <fieldset>
            <label class="col-form-label mt-1">
                <h3>Ингредиенты:</h3>
            </label>
            <div class="form-group" id="form-container">
                {{ formset.management_form }}
                {{ formset.non_form_erros }}
                {% for form in formset %}
                <div class="form-style">
                    <div class="form-group ingredient-form">
                        {{ form.errors }}
                        {{ form.as_table }}
                    </div>
                </div>
                {% endfor %}
                <button class="btn btn-primary" id="add-form" type="button">Добавить еще один ингредиент</button>
            </div>
        </fieldset>
        <button class="btn btn-primary" type="submit">Отправить</button>
        <div style="margin-top: 18px;">
            <a class="btn btn-danger" href="{% url 'delete_recipe' recipe_pk %}">Удалить рецепт</a>
        </div>
    </form>

</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
        let ingredientForm = document.querySelectorAll(".ingredient-form")
        let ingredientFormTemplate = document.querySelectorAll(".ingredient-form")[0].cloneNode(true)
        let container = document.querySelector("#form-container")
        let addButton = document.querySelector("#add-form")
        let totalForms = document.querySelector("#id_ingredient_set-TOTAL_FORMS")


        $(document).ready(function () {
            let regex = RegExp('id="id_ingredient_set-(\\d*)-ingredient', 'g')
            let iter = container.innerHTML.matchAll(regex)
            let res = iter.next()
            while (!res.done) {
                console.log(res.value[1])
                $('#id_ingredient_set-' + res.value[1] + '-ingredient').select2()

                res = iter.next()
            }

        });


        let formNum = ingredientForm.length - 1
        addButton.addEventListener('click', addForm)

        function addForm(e) {
            e.preventDefault()

            let newForm = ingredientFormTemplate.cloneNode(true)
            let formRegex = RegExp(`ingredient_set-(\\d){1}-`, 'g')

            formNum++

            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `ingredient_set-${formNum}-`)

            container.insertBefore(newForm, addButton)
            totalForms.setAttribute('value', `${formNum + 1}`)

            $('#id_ingredient_set-' + formNum + '-ingredient').select2();
        }








</script>

{% endblock %}
